import{_ as G}from"./VMultiSelect.aFZl8ywf.js";import{z as K,u as T,b as V,d as H,r as f,e as I,v as W,g as r,h as i,i as o,n as b,t as l,l as y,k as h,w as X,Q as F,K as k,F as Y,y as Z,j as v,x as tt,p as et}from"./index.GdMxdeuf.js";import{F as at}from"./vee-validate.esm.9aElOHQY.js";import{c as C,h as ot,a as R}from"./index.esm.0vhAmrVd.js";import{_ as U}from"./VTextInput.ZgtOiOMJ.js";import{B as st}from"./BeatLoader.czpWuXPY.js";import{u as nt}from"./global.8gHgB6cY.js";import{C as rt}from"./ClipLoader.UcGuNCxH.js";import"./VTooltip.Ewb958d6.js";/* empty css                                                   *//* empty css                                                   */const _t={class:"modal hide",id:"returnInvoiceModal",tabindex:"-1","aria-labelledby":"Add Category","aria-modal":"true",role:"dialog","data-bs-backdrop":"static","data-bs-keyboard":"false"},it={class:"modal-dialog modal-xl modal-dialog-centered"},ut={class:"modal-content"},lt={class:"modal-header"},dt={class:"modal-title text-primary"},ct={key:0},pt={class:"modal-body"},mt={key:0},ht={key:1},gt={class:"row"},yt={class:"col-6"},vt={class:"form-field"},ft={class:"form-check form-switch"},bt={class:"form-check-label"},Ft={class:"col-6"},kt={class:"text-end text-primary"},qt={class:"table-responsive mt-3"},xt={class:"table table-hover table-bordered mb-3 table-responsive-data"},wt={class:"bg-light"},Vt={class:"text-center",width:"5%"},$t={width:"10%"},It={width:"30%"},Ct={width:"10%"},Rt={width:"20%"},Ut={class:"text-center"},Mt=["onUpdate:modelValue"],Et={key:1},St={class:"text-center"},Nt={key:0,class:"form-switch"},Bt=["onUpdate:modelValue"],Dt={key:1},Ot={key:0},Qt={key:0},zt={key:1},Lt={class:"row pt-3"},At={class:"col-4"},Pt={class:"col-4"},jt={key:0,class:"col-md-4"},Jt={class:"row pt-2"},Gt={class:"col-12 text-end"},Kt=["disabled"],Tt={key:1,class:"pt-0"},Ht={key:2,class:"pt-0"},Wt={__name:"ReturnInvoiceModal",emits:["refreshInvoices"],setup(Xt,{expose:M,emit:E}){const{t:c}=T(),S=V(),N=H(()=>S.user.currency.symbol),q=f({other_reason:c("Other Reason"),other_reason_placeholder:c("Enter returned reason...")}),x={server_messages:{type:"",messages:""},is_checked_returning_entire_invoice:!1,is_listing:!1,is_submitting:!1,items:[],reason:"",other_reason:"",payment_method_id:""},{order_returned_reasons:B}=nt(),e=I({...x}),D=C({items:ot(C({quantity:R().test({name:"max",exclusive:!1,params:{},test:function(t,a){var s=$('[name="'+a.path+'"]').attr("max");return isNaN(parseFloat(t))||t==""?a.createError({path:`${a.path}`,message:c("must be a positive number or 0",{name:c("Quantity")})}):t<=parseFloat(s)?!0:a.createError({path:`${a.path}`,message:c("must be less than or equal to n",{name:c("Quantity"),number:s})})}})})),reason:R().required(c("name is required",{name:c("Reason")}))});function O(){$("#returnInvoiceModal").modal("hide")}M({getInvoiceDetail:Q});const p=f("");async function Q(t){j(),e.is_listing=!0,await axios.get("/api/invoice/"+t).then(a=>{p.value=a.data.data,e.items=p.value.invoice_products.map(s=>{var u=s.product_quantity-s.returned_quantity;return{product_type:s.type,return_to_stock:1,is_refundable:s.is_refundable,product_name:s.product_name,product_name_ar:s.product_name_ar,product_amount:s.product_amount,invoice_product_slack:s.slack,is_returning:!1,product_quantity:s.product_quantity,available_quantity:u.toFixed(2),returning_quantity:0,returning_amount:0,product_price:s.product_price,product_price_without_tax:s.product_price_without_tax,subtotal_after_product_quantity:s.subtotal_after_product_quantity,product_discount:s.product_discount,subtotal_after_product_discount:s.subtotal_after_product_discount,invoice_discount_amount:s.invoice_discount_amount,additional_fee_amount:s.additional_fee_amount,tobacco_tax_amount:s.tobacco_tax_amount,subtotal_after_product_other_taxes_and_fee:s.subtotal_after_product_other_taxes_and_fee,product_tax:s.product_tax}}),e.items=_.filter(e.items,s=>s.is_refundable),e.is_listing=!1}).catch(a=>{e.server_messages.type="error",e.server_messages.messages=a,console.log(a)})}const z=E;async function L(){e.is_submitting=!0;let t=new FormData;t.append("invoice_slack",p.value.slack),t.append("items",JSON.stringify(_.filter(e.items,a=>a.is_returning))),t.append("reason",e.reason=="Other"?e.other_reason:e.reason),t.append("payment_method_id",e.payment_method_id),await axios.post("/api/return_invoice/save",t).then(a=>{if(a.data.status_code==200)toast.success(a.data.msg),e.is_submitting=!1,z("refreshInvoices"),$("#returnInvoiceModal").modal("hide"),window.open(a.data.receipt_link,"_blank");else{try{e.server_messages.type="error",e.server_messages.messages=JSON.parse(a.data.msg)}catch{e.server_messages.type="error",e.server_messages.messages=a.data.msg}e.is_submitting=!1}}).catch(a=>{e.server_messages.type="error",e.server_messages.messages=a,console.log(a)})}W(()=>e.is_checked_returning_entire_invoice,t=>{t?e.items=_.forEach(e.items,a=>{a.returning_quantity=a.available_quantity,a.is_returning=!0}):e.items=_.forEach(e.items,a=>{a.returning_quantity=0,a.is_returning=!1}),g()});const A=_.debounce(function(){g()},700);function g(){V().user.login_branch.tax_inclusive_pricing,_.forEach(e.items,t=>{t.returning_quantity<=0||!t.is_returning?t.returning_amount=0:(t.returning_product_price=t.product_price,t.returning_product_price_without_tax=t.product_price_without_tax,t.returning_subtotal_after_product_quantity=t.subtotal_after_product_quantity>0?parseFloat(t.subtotal_after_product_quantity)/parseFloat(t.product_quantity)*parseFloat(t.returning_quantity):0,t.returning_discount_amount=t.product_discount>0?parseFloat(t.product_discount)/parseFloat(t.product_quantity)*parseFloat(t.returning_quantity):0,t.returning_subtotal_after_product_discount=t.subtotal_after_product_discount>0?parseFloat(t.subtotal_after_product_discount)/parseFloat(t.product_quantity)*parseFloat(t.returning_quantity):0,t.returning_invoice_discount_amount=t.invoice_discount_amount>0?parseFloat(t.invoice_discount_amount)/parseFloat(t.product_quantity)*parseFloat(t.returning_quantity):0,t.returning_additional_fee_amount=t.additional_fee_amount>0?parseFloat(t.additional_fee_amount)/parseFloat(t.product_quantity)*parseFloat(t.returning_quantity):0,t.returning_tobacco_tax_amount=t.tobacco_tax_amount>0?parseFloat(t.tobacco_tax_amount)/parseFloat(t.product_quantity)*parseFloat(t.returning_quantity):0,t.returning_subtotal_after_product_other_taxes_and_fee=t.subtotal_after_product_other_taxes_and_fee>0?parseFloat(t.subtotal_after_product_other_taxes_and_fee)/parseFloat(t.product_quantity)*parseFloat(t.returning_quantity):0,t.returning_tax_amount=t.product_tax>0?parseFloat(t.product_tax)/parseFloat(t.product_quantity)*parseFloat(t.returning_quantity):0,t.returning_amount=parseFloat(t.product_amount)/parseFloat(t.product_quantity)*parseFloat(t.returning_quantity))}),P()}const m=I({grand_discount_amount:0,subtotal_after_grand_discount:0,other_taxes_and_fee:0,subtotal_after_other_taxes_and_fee:0,tax:0,subtotal_after_tax:0,grand_amount:0});function P(){if(p.value.invoice_discount>0){var t=0,a=0;if(_.forEach(e.items,function(n){t+=parseFloat(n.subtotal_after_product_quantity),a+=parseFloat(n.returning_amount)}),a>0){let n=parseFloat(p.value.invoice_discount)/parseFloat(t)*parseFloat(a);m.grand_discount_amount=parseFloat(n).toFixed(2)}else m.grand_discount_amount=0}let s=_.reduce(e.items,function(n,d){return parseFloat(n)+parseFloat(d.returning_amount)},0);m.grand_amount=(parseFloat(s)-parseFloat(m.grand_discount_amount)).toFixed(2);let u=_.reduce(e.items,function(n,d){return d.is_returning?parseFloat(n)+parseFloat(d.returning_tax_amount):parseFloat(n)+0},0);m.tax=parseFloat(u).toFixed(2)}function j(){Object.assign(e,x)}const w=f([]);J();async function J(){let t=await axios.get("api/payment_methods/all");w.value=t.data.data}return(t,a)=>{const s=G;return r(),i("div",_t,[o("div",it,[o("div",ut,[o("div",lt,[o("h5",dt,[b(l(t.$t("Returning Items"))+" - Invoice #",1),p.value!=""?(r(),i("span",ct,l(p.value.invoice_number),1)):y("",!0)]),o("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal","aria-label":"Close",onClick:O,id:"close_btn"})]),o("div",pt,[e.is_listing?(r(),i("div",mt,[h(st,{color:"gray",size:"15px",class:"pt-2 pe-2"})])):(r(),i("div",ht,[h(v(at),{"validation-schema":v(D),onSubmit:L,enctype:"multipart/form-data"},{default:X(()=>[o("div",gt,[o("div",yt,[o("div",vt,[o("div",ft,[o("label",bt,[k(o("input",{type:"checkbox",class:"form-check-input me-2",role:"switch",name:"is_checked_returning_entire_invoice",id:"is_checked_returning_entire_invoice","unchecked-value":!1,"onUpdate:modelValue":a[0]||(a[0]=u=>e.is_checked_returning_entire_invoice=u),onChange:a[1]||(a[1]=u=>g())},null,544),[[F,e.is_checked_returning_entire_invoice]]),b(" "+l(t.$t("Return Entire Invoice")),1)])])])]),o("div",Ft,[o("p",kt,"Invoice Amount: "+l(p.value.grand_product_amount)+" "+l(N.value),1)])]),o("div",qt,[o("table",xt,[o("thead",wt,[o("tr",null,[o("th",Vt,l(t.$t("Refund")),1),o("th",$t,l(t.$t("Update Inventory")),1),o("th",It,l(t.$t("Product")),1),o("th",Ct,l(t.$t("Qty Left")),1),o("th",Rt,l(t.$t("Qty to Return")),1)])]),o("tbody",null,[(r(!0),i(Y,null,tt(e.items,(u,n)=>(r(),i("tr",null,[o("td",Ut,[e.items[n].available_quantity>0?k((r(),i("input",{key:0,type:"checkbox","onUpdate:modelValue":d=>u.is_returning=d,onChange:a[2]||(a[2]=d=>g())},null,40,Mt)),[[F,u.is_returning]]):(r(),i("span",Et,"--"))]),o("td",St,[e.items[n].available_quantity>0&&e.items[n].product_type==1?(r(),i("div",Nt,[k(o("input",{type:"checkbox",class:"form-check-input me-2",role:"switch",name:"return_to_stock",id:"return_to_stock","unchecked-value":!1,"onUpdate:modelValue":d=>e.items[n].return_to_stock=d},null,8,Bt),[[F,e.items[n].return_to_stock]])])):(r(),i("div",Dt,"--"))]),o("td",null,[b(l(e.items[n].product_name)+" ",1),e.items[n].product_name_ar!=""&&e.items[n].product_type==1?(r(),i("span",Ot,l(e.items[n].product_name_ar),1)):y("",!0)]),o("td",null,l(e.items[n].available_quantity),1),e.items[n].available_quantity>0?(r(),i("td",Qt,[h(U,{type:"number",name:"items["+n+"].quantity",modelValue:e.items[n].returning_quantity,"onUpdate:modelValue":d=>e.items[n].returning_quantity=d,max:e.items[n].available_quantity,min:"0",islabel:!1,class:Z("mt-0"),onInput:a[3]||(a[3]=d=>v(A)())},null,8,["name","modelValue","onUpdate:modelValue","max"])])):(r(),i("td",zt,"-- "))]))),256))])])]),o("div",Lt,[o("div",At,[h(s,{name:"payment_method",mode:"single",text:"name",value:"id",label:"Payment Method",modelValue:e.payment_method_id,"onUpdate:modelValue":a[4]||(a[4]=u=>e.payment_method_id=u),options:w.value,required:""},null,8,["modelValue","options"])]),o("div",Pt,[h(s,{name:"reason",mode:"single",label:"Returned Reason",modelValue:e.reason,"onUpdate:modelValue":a[5]||(a[5]=u=>e.reason=u),options:v(B),required:""},null,8,["modelValue","options"])]),e.reason=="Other"?(r(),i("div",jt,[h(U,{type:"text",name:"other_reason",modelValue:e.other_reason,"onUpdate:modelValue":a[6]||(a[6]=u=>e.other_reason=u),label:q.value.other_reason,placeholder:q.value.other_reason_placeholder},null,8,["modelValue","label","placeholder"])])):y("",!0)]),o("div",Jt,[o("div",Gt,[o("button",{type:"submit",class:"btn btn-primary",disabled:e.is_submitting||m.grand_amount<=0},[e.is_submitting?(r(),et(rt,{key:0,color:"white",size:"20px",class:"pt-2 pe-2"})):y("",!0),e.is_submitting?(r(),i("span",Tt," Submitting... ")):(r(),i("span",Ht," Submit "))],8,Kt)])])]),_:1},8,["validation-schema"])]))])])])])}}},ue=K(Wt,[["__scopeId","data-v-ce5fd9d6"]]);export{ue as default};
